
## Model-In-The-Loop (MIL) Simulation

Model-In-The-Loop is the simulation in an early development phase of modeling in the area of model-based design. MIL is a cheap way to test algorithms. In order to function properly, the algorithms must be simulated before deployment to real hardware to detect any serious bug which could result in catastrophic consequences.

Model-In-The-Loop simulation is a method that your model is developed and executed in a simulation environment such as Simulink. A typical model structure for autopilot system is shown blow.

<img src="figures/mil_model.png" width="50%">

### Setting Up MIL Simulation

1. Open FMT-Model in Matlab (version 2018b or higher).
2. Double click **FMT_Model.prj** to open and initialize the project.
3. Open simulation model `simulation/MILSIM.slx`.

### RC Input
The RC (Remote Control) input can be generated by `MILSIM/FCS/RC` block. Currently there are four choices can be selected. To change active choice, right click the blank area and choose *Variant->Label Model Active Choice*.

<img src="figures/rc_block.png" width="30%">

- **Joystick**:  The rc signal is sent by plugging in the joystick, e.g, a gamepad with usb cable.
- **Mavlink**：The rc signal is sent by flight controller via mavlink protocol. So you need connect rc receiver to your flight controller and connect it with your computer. Make sure the `#define FMT_OUTPUT_PILOT_CMD` macro is uncomment, and your flight controller can receive rc signal properly. 
- **Fake**：The rc signal is contructed by simulink slider block. A fake remote control signal can be simulated.
- **None**：This is used to build situations without a rc (rc disconnect). So you can use other input source, such ground station or onboard computer to control the vehicle.

### GCS Input
The GCS (Ground Control Station) input can be generated by `MILSIM/FCS/GCS` block. You can use GCS to send command to control the vehicle.

You can also set mode via GCS. Since RC has higher priority than GCS, so you need make RC invalid (Select None), then you can set mode by GCS.

### Auto Command
Auto Command is used to send external control commands to FMS. Auto command is valid only if Offboard mode is active.

### Mission Data
Mission Data is used to send waypoint data to FMS. The mission data comply with mavlink mission protocol. For more information, please check [Mission Protocol · MAVLink Developer Guide](https://mavlink.io/en/services/mission.html).

### Visualization

The default visualization tool is MATLAB 3D. Double click visualization block `MILSIM/Virtualization/3D_Visualization/Matlab_3D/Visualization/VR Sink`. Set viewpoint to *Isometric - No Rotation*.

<img src="figures/matlab_3D.png" width="40%">

The plant model generates vehicle states such as attitude, position, etc. These information can be sent to any visualization software, such as Flightgear, Gazebo, Webots, etc.

<img src="figures/flightgear.png" width="40%">

### Run Simulation
There are many ways to run the MIL simulation, You can control it as if it is a real vehicle. Here we just introduce a way to perform simulation of Mission mode.

1. Set RC active choice to *None*.
2. Set GCS mode to *PilotMode.Mission*.
3. Click Run button to start simulation.
4. Change GCS cmd_1 from *FMS_Cmd.None* to *FMS_Cmd.PreArm*(cmd_1 is avtive when changed).

### Data Analyze
When simulation is done, you can analyze the simulation data via *Simulation Data Inspector* to inspect simulation data.

<img src="figures/mil_sdi.png" width="50%">

